<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">

    <style type="text/css">
        body {
            font: 14px "Open Sans", "Arial", sans-serif;
        }

        video {
            margin-top: 20px;
            border: 1px solid black;
        }

        canvas {
            margin-top: 20px;
            border: 1px solid black;
        }

        .button {
            cursor: pointer;
            width: 150px;
            border: 1px solid black;
            font-size: 16px;
            text-align: center;
            padding-top: 2px;
            padding-bottom: 4px;
            color: white;
            background-color: darkgreen;
        }

        .wrapper {
            margin-bottom: 10px;
            width: 600px;
        }

        .trackrow {
            height: 200px;
        }

        .leftside {
            float: left;
            width: calc(calc(100%/2) - 10px);
        }

        .rightside {
            float: right;
            width: calc(calc(100%/2) - 10px);
        }

        textarea {
            padding: 8px;
        }

        h3 {
            margin-bottom: 3px;
        }

        #supportedConstraints {
            column-count: 2;
            -moz-column-count: 2;
        }

        #log {
            padding-top: 10px;
        }
    </style>

    <title>Capabilities, constraints, and settings - Example_Constraint_exerciser - code sample</title>
</head>

<body>

    <video id="video" autoplay width="320" height="240"></video>
    <canvas id="videoCanvas" width="320" height="240"></canvas>
    <div id="startButton" class="button">
        Start
    </div>
    <div class="button" id="stopButton">
        Stop Video
    </div>
    <div style=" width:850px;height:100px;margin: 1px 10px;">
        <div id="no_rtc" class="alert alert-error" style="display:none;"></div>
        <div id="log" class="alert alert-info"></div>
    </div>
    <p>Experiment with media constraints! Edit the constraint sets for the
        video and audio tracks in the edit boxes on the left, then click the
        "Apply Constraints" button to try them out. The actual settings the
        browser selected and is using are shown in the boxes on the right.
        Below all of that, you'll see the video itself.</p>
    <p>Click the "Start" button to begin.</p>

    <h3>Constrainable properties available:</h3>
    <ul id="supportedConstraints">
    </ul>
    <div class="wrapper">
        <div class="trackrow">
            <div class="leftside">
                <h3>Requested video constraints:</h3>
                <textarea id="videoConstraintEditor" cols=32 rows=8></textarea>
            </div>
            <div class="rightside">
                <h3>Actual video settings:</h3>
                <textarea id="videoSettingsText" cols=32 rows=8 disabled></textarea>
            </div>
        </div>
        <div class="trackrow">
            <div class="leftside">
                <h3>Requested audio constraints:</h3>
                <textarea id="audioConstraintEditor" cols=32 rows=8></textarea>
            </div>
            <div class="rightside">
                <h3>Actual audio settings:</h3>
                <textarea id="audioSettingsText" cols=32 rows=8 disabled></textarea>
            </div>
        </div>

        <div class="button" id="applyButton">
            Apply Constraints
        </div>
    </div>

    <div id="log">
    </div>


    <script type="text/javascript" src="../../../js/inspirit-jsfeat-4c7b336/build/jsfeat-min.js"></script>
    <script type="text/javascript" src="../../../js/inspirit-jsfeat-4c7b336/src/compatibility.js"></script>
    <script type="text/javascript" src="../../../js/inspirit-jsfeat-4c7b336/src/profiler.js"></script>
    <script type="text/javascript" src="../../../js/inspirit-jsfeat-4c7b336/src/dat.gui.min.js"></script>

    <script type="text/javascript">
        "use strict";
        //OK, kan jag alltså böka in FAST corners här o vise liesom lite lätt?
        //OK, kan jag alltså böka in FAST corners här o vise liesom lite lätt?
        //OK, kan jag alltså böka in FAST corners här o vise liesom lite lätt?
        //OK, kan jag alltså böka in FAST corners här o vise liesom lite lätt?
        //OK, kan jag alltså böka in FAST corners här o vise liesom lite lätt?
        //OK, kan jag alltså böka in FAST corners här o vise liesom lite lätt?

        // lets do some fun
        var video = document.getElementById('video');
        var canvas = document.getElementById('videoCanvas');

        var onDimensionsReady = function (width, height) {
            demo_app(width, height);
            compatibility.requestAnimationFrame(tick);
        };

        var stat = new profiler();

        var gui, options, ctx, canvasWidth, canvasHeight;
        var img_u8, corners, threshold;

        var demo_opt = function () {
            this.threshold = 14;
        }

        function demo_app(videoWidth, videoHeight) {
            canvasWidth = canvas.width;
            canvasHeight = canvas.height;
            ctx = canvas.getContext('2d');

            ctx.fillStyle = "rgb(0,255,0)";
            ctx.strokeStyle = "rgb(0,255,0)";

            img_u8 = new jsfeat.matrix_t(320, 240, jsfeat.U8_t | jsfeat.C1_t);

            corners = [];
            var i = 320 * 240;
            while (--i >= 0) {
                corners[i] = new jsfeat.keypoint_t(0, 0, 0, 0);
            }

            threshold = 14;

            jsfeat.fast_corners.set_threshold(threshold);

            options = new demo_opt();
            gui = new dat.GUI();

            gui.add(options, 'threshold', 5, 100).step(1);

            stat.add("grayscale");
            stat.add("fast corners");
        }

        function tick() {
            compatibility.requestAnimationFrame(tick);
            stat.new_frame();
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                ctx.drawImage(video, 0, 0, 320, 240);
                var imageData = ctx.getImageData(0, 0, 320, 240);

                stat.start("grayscale");
                jsfeat.imgproc.grayscale(imageData.data, 320, 240, img_u8);
                stat.stop("grayscale");

                if (threshold != options.threshold) {
                    threshold = options.threshold | 0;
                    jsfeat.fast_corners.set_threshold(threshold);
                }

                stat.start("fast corners");
                var count = jsfeat.fast_corners.detect(img_u8, corners, 5);
                stat.stop("fast corners");

                // render result back to canvas
                var data_u32 = new Uint32Array(imageData.data.buffer);
                render_corners(corners, count, data_u32, 320);

                ctx.putImageData(imageData, 0, 0);
            }
        }

        function render_corners(corners, count, img, step) {
            var pix = (0xff << 24) | (0x00 << 16) | (0xff << 8) | 0x00;
            for (var i = 0; i < count; ++i) {
                var x = corners[i].x;
                var y = corners[i].y;
                var off = (x + y * step);
                img[off] = pix;
                img[off - 1] = pix;
                img[off + 1] = pix;
                img[off - step] = pix;
                img[off + step] = pix;
            }
        }

        //mine fonketione
        function webCamFeed(video) {
            setInterval(function () {
                var canvas = document.getElementById('videoCanvas');
                var ctxx = canvas.getContext("2d");
                ctxx.drawImage(video, 0, 0, 320, 240);
            }, 100);
        }
        //OK, kan jag alltså böka in FAST corners här o vise liesom lite lätt?
        //OK, kan jag alltså böka in FAST corners här o vise liesom lite lätt?
        //OK, kan jag alltså böka in FAST corners här o vise liesom lite lätt?
        //OK, kan jag alltså böka in FAST corners här o vise liesom lite lätt?
        //OK, kan jag alltså böka in FAST corners här o vise liesom lite lätt?
        //OK, kan jag alltså böka in FAST corners här o vise liesom lite lätt?

        let videoDefaultConstraintString = '{\n  "width": 320,\n  "height": 240,\n  "frameRate": 3\n}';
        let audioDefaultConstraintString = '{\n  "sampleSize": 16,\n  "channelCount": 2,\n  "echoCancellation": false\n}';
        let videoConstraints = null;
        let audioConstraints = null;

        let audioTrack = null;
        let videoTrack = null;
        let videoElement = document.getElementById("video");
        let canvasElement = document.getElementById("videoCanvas")
        let logElement = document.getElementById("log");
        let supportedConstraintList = document.getElementById("supportedConstraints");
        let videoConstraintEditor = document.getElementById("videoConstraintEditor");
        let audioConstraintEditor = document.getElementById("audioConstraintEditor");
        let videoSettingsText = document.getElementById("videoSettingsText");
        let audioSettingsText = document.getElementById("audioSettingsText");
        videoConstraintEditor.value = videoDefaultConstraintString;
        audioConstraintEditor.value = audioDefaultConstraintString; function getCurrentSettings() {
            if (videoTrack) {
                videoSettingsText.value = JSON.stringify(videoTrack.getSettings(), null, 2);
            }
            if (audioTrack) {
                audioSettingsText.value = JSON.stringify(audioTrack.getSettings(), null, 2);
            }
        }
        function buildConstraints() {
            try {
                videoConstraints = JSON.parse(videoConstraintEditor.value);
                audioConstraints = JSON.parse(audioConstraintEditor.value);
            } catch (error) {
                handleError(error);
            }
        }
        function startVideo() {
            buildConstraints();
            navigator.mediaDevices.getUserMedia({
                video: videoConstraints,
                audio: audioConstraints
            }).then(function (stream) {
                let audioTracks = stream.getAudioTracks();
                let videoTracks = stream.getVideoTracks();

                //Videon börjer vises
                videoElement.srcObject = stream;

                //Här starter vi mitt mög
                webCamFeed(videoElement);
                onDimensionsReady(320, 240);
                //Här starter vi mitt mög

                if (audioTracks.length) {
                    audioTrack = audioTracks[0];
                }
                if (videoTracks.length) {
                    videoTrack = videoTracks[0];
                }
            }).then(function () {
                new Promise(function (resolve) {
                    videoElement.onloadedmetadata = resolve;
                });
            }).then(function () {
                getCurrentSettings();
            }).catch(handleError);
        }
        document.getElementById("startButton").addEventListener("click", function () {
            startVideo();
        }, false);
        document.getElementById("applyButton").addEventListener("click", function () {
            if (!videoTrack && !audioTrack) {
                startVideo();
            } else {
                buildConstraints();
                if (videoTrack) {
                    videoTrack.applyConstraints(videoConstraints).then(function () {
                        videoSettingsText.value = JSON.stringify(videoTrack.getSettings(), null, 2);
                    }).catch(handleError);
                }

                if (audioTrack) {
                    audioTrack.applyConstraints(audioConstraints).then(function () {
                        audioSettingsText.value = JSON.stringify(audioTrack.getSettings(), null, 2);
                    }).catch(handleError);
                }
            }
        }, false);
        document.getElementById("stopButton").addEventListener("click", function () {
            if (videoTrack) {
                videoTrack.stop();
            }
            if (audioTrack) {
                audioTrack.stop();
            }

            videoTrack = audioTrack = null;
            videoElement.srcObject = null;
        });
        function keyDownHandler(event) {
            if (event.key == "Tab") {
                let elem = event.target;
                let str = elem.value;

                let position = elem.selectionStart;
                let newStr = str.substring(0, position) + "  " +
                    str.substring(position, str.length);
                elem.value = newStr;
                elem.selectionStart = elem.selectionEnd = position + 2;
                event.preventDefault();
            }
        }

        videoConstraintEditor.addEventListener("keydown", keyDownHandler, false);
        audioConstraintEditor.addEventListener("keydown", keyDownHandler, false);
        let supportedConstraints = navigator.mediaDevices.getSupportedConstraints();
        for (let constraint in supportedConstraints) {
            if (supportedConstraints.hasOwnProperty(constraint)) {
                let elem = document.createElement("li");

                elem.innerHTML = "<code><a href='https://developer.mozilla.org/docs/Web/API/MediaTrackSupportedConstraints/"
                    .concat(constraint) + "' target='_blank'>" + constraint + "</a></code>";
                supportedConstraintList.appendChild(elem);
            }
        }
        function log(msg) {
            logElement.innerHTML += (msg + "<br>");
        }

        function handleError(reason) {
            log("Error <code>" + reason.name +
                "</code> in constraint <code>" + reason.constraint +
                "</code>: " + reason.message);
        }

    </script>

</body>

</html>